name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:

  # 1. Unit Tests
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm vitest --run --exclude e2e/**


  # 2. E2E Tests
  e2e-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm playwright install --with-deps

      - name: Run E2E tests
        run: pnpm test:e2e


  # 3. Format Check
  format-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Add Prettier ignore rules for CI and Compose
        run: |
          echo ".github/workflows/" >> .prettierignore
          echo "docker-compose.yml" >> .prettierignore
          echo "README.md" >> .prettierignore

      - name: Prettier format check
        run: pnpm prettier --check .


  # Auto-format fix
  auto-format-fix:
    runs-on: ubuntu-latest
    needs: format-check
    if: failure()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Add Prettier ignore rules for CI and Compose
        run: |
          echo ".github/workflows/" >> .prettierignore
          echo "docker-compose.yml" >> .prettierignore
          echo "README.md" >> .prettierignore

      - name: Run Prettier auto-fix
        run: pnpm prettier --write .

      - name: Fix readme manually if Prettier skipped it
        run: pnpm prettier --write README.md

      - name: Commit auto-format changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: auto-format code via CI" || echo "No changes to commit"

      - name: Push changes
        run: git push --force-with-lease


  # Verify formatting after auto-fix
  verify-format-fix:
    runs-on: ubuntu-latest
    needs: auto-format-fix
    if: success() || failure()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Add Prettier ignore rules for CI and Compose
        run: |
          echo ".github/workflows/" >> .prettierignore
          echo "docker-compose.yml" >> .prettierignore
          echo "README.md" >> .prettierignore

      - name: Verify formatting after auto-fix
        run: pnpm prettier --check .


  # 4. Linter
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint


  # 5. Documentation Build Check
  docs-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Storybook
        run: pnpm build-storybook


  # 6. Docker Build Check
  docker-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t app .


  # 7. App Build Check
  app-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

